
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Géolocalisation Cellulaire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>
  <div id="map">Chargement de la carte...</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const mcc = parseInt(params.get("mobileCountryCode"));
    const mnc = parseInt(params.get("mobileNetworkCode"));
    const lac = parseInt(params.get("locationAreaCode"));
    const cid = parseInt(params.get("cellId"));

    const cells = [cid].concat(
      ["cell1", "cell2", "cell3", "cell4"]
        .map(key => parseInt(params.get(key)))
        .filter(val => !isNaN(val))
    );

    const cellTowers = cells.map(cellId => ({
      radioType: "gsm",
      mobileCountryCode: mcc,
      mobileNetworkCode: mnc,
      locationAreaCode: lac,
      cellId: cellId
    }));

    fetch("https://location.services.mozilla.com/v1/geolocate?key=test", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cellTowers })
    })
    .then(response => response.json())
    .then(data => {
      const lat = data.location.lat;
      const lng = data.location.lng;
      const accuracy = data.accuracy || 1000;

      const map = L.map('map').setView([lat, lng], 16);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      L.marker([lat, lng]).addTo(map)
        .bindPopup(`Position estimée (±${Math.round(accuracy)}m)`)
        .openPopup();

      L.circle([lat, lng], {
        radius: accuracy,
        color: 'blue',
        fillOpacity: 0.2
      }).addTo(map);
    })
    .catch(err => {
      document.getElementById("map").innerHTML = "<p>Erreur de géolocalisation.</p>";
      console.error(err);
    });
  </script>
</body>
</html>

